package cn.hackedmc.alexander.module.impl.exploit.disabler;

import cn.hackedmc.alexander.Client;
import cn.hackedmc.alexander.component.impl.player.RotationComponent;
import cn.hackedmc.alexander.module.impl.exploit.Disabler;
import cn.hackedmc.alexander.newevent.Listener;
import cn.hackedmc.alexander.newevent.Priorities;
import cn.hackedmc.alexander.newevent.annotations.EventLink;
import cn.hackedmc.alexander.newevent.impl.motion.PostMotionEvent;
import cn.hackedmc.alexander.newevent.impl.other.WorldChangeEvent;
import cn.hackedmc.alexander.newevent.impl.packet.PacketReceiveEvent;
import cn.hackedmc.alexander.newevent.impl.packet.PacketSendEvent;
import cn.hackedmc.alexander.value.Mode;
import cn.hackedmc.alexander.value.impl.BooleanValue;
import net.minecraft.network.INetHandler;
import net.minecraft.network.Packet;
import net.minecraft.network.play.INetHandlerPlayClient;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.client.C0BPacketEntityAction;

import java.util.concurrent.LinkedBlockingQueue;

public class GrimACDisabler extends Mode<Disabler> {
    public GrimACDisabler(String name, Disabler parent) {
        super(name, parent);
    }
    public final BooleanValue post = new BooleanValue("Post", this, false);
    private final BooleanValue badPacketsF = new BooleanValue("Bad Packets F", this, false);
    private final BooleanValue badPacketsG = new BooleanValue("Bad Packets G", this, false);
    private final BooleanValue higherVersion = new BooleanValue("Move 1.17+", this, false);

    private boolean sprinting;
    private boolean sneaking;
    public LinkedBlockingQueue<Packet<INetHandlerPlayClient>> packets = new LinkedBlockingQueue<>();

    @Override
    public void onEnable() {
        reset();
    }

    @EventLink
    private final Listener<WorldChangeEvent> onWorldChange = event -> {
        reset();
    };

    @EventLink(value = Priorities.VERY_HIGH)
    private final Listener<PostMotionEvent> onMotionPost = event -> {
        if (!packets.isEmpty()) {
            for (Packet<INetHandlerPlayClient> packet : packets) {
                final PacketReceiveEvent packetReceiveEvent = new PacketReceiveEvent(packet);
                Client.INSTANCE.getEventBus().handle(packetReceiveEvent);

                if (packetReceiveEvent.isCancelled()) {
                    continue;
                }

                packet.processPacket(mc.getNetHandler());
            }

            packets.clear();
        }
    };

    @EventLink
    private final Listener<PacketSendEvent> onPacketSend = event -> {
        Packet<?> packet = event.getPacket();

        if (packet instanceof C0BPacketEntityAction) {
            final C0BPacketEntityAction wrapped = (C0BPacketEntityAction) packet;

            if (badPacketsF.getValue()) {
                if (wrapped.getAction() == C0BPacketEntityAction.Action.START_SPRINTING) {
                    if (sprinting)
                        event.setCancelled();

                    sprinting = true;
                }

                if (wrapped.getAction() == C0BPacketEntityAction.Action.STOP_SPRINTING) {
                    if (!sprinting)
                        event.setCancelled();

                    sprinting = false;
                }
            }

            if (badPacketsG.getValue()) {
                if (wrapped.getAction() == C0BPacketEntityAction.Action.START_SNEAKING) {
                    if (sneaking)
                        event.setCancelled();

                    sneaking = true;
                }

                if (wrapped.getAction() == C0BPacketEntityAction.Action.STOP_SNEAKING) {
                    if (!sneaking)
                        event.setCancelled();

                    sneaking = false;
                }
            }
        }

        if (higherVersion.getValue() && packet instanceof C03PacketPlayer && !(packet instanceof C03PacketPlayer.C06PacketPlayerPosLook)) {
            final C03PacketPlayer wrapped = (C03PacketPlayer) packet;

            if (wrapped.moving) {
                mc.getNetHandler().addToSendQueueUnregistered(new C03PacketPlayer.C06PacketPlayerPosLook(
                        wrapped.x,
                        wrapped.y,
                        wrapped.z,
                        RotationComponent.rotations.x,
                        RotationComponent.rotations.y,
                        wrapped.onGround
                ));
            } else if (wrapped.rotating) {
                mc.getNetHandler().addToSendQueueUnregistered(new C03PacketPlayer.C06PacketPlayerPosLook(
                        mc.thePlayer.posX,
                        mc.thePlayer.posY,
                        mc.thePlayer.posZ,
                        wrapped.yaw,
                        wrapped.pitch,
                        wrapped.onGround
                ));
            } else {
                mc.getNetHandler().addToSendQueueUnregistered(new C03PacketPlayer.C06PacketPlayerPosLook(
                        mc.thePlayer.posX,
                        mc.thePlayer.posY,
                        mc.thePlayer.posZ,
                        RotationComponent.rotations.x,
                        RotationComponent.rotations.y,
                        wrapped.onGround
                ));
            }
        }
    };

    private void reset() {
        sprinting = false;
        sneaking = false;
        packets.clear();
    }
}
